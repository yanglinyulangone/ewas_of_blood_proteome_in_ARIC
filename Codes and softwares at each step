**Step 1: Preprocessing and quality control of DNA methylation data**
Adapted from the CPACOR framework and the Infinium preprocessing pipeline (https://github.com/genepi-freiburg/Infinium-preprocessing). The pipeline was executed twice: in the first run, outlier samples were identified; these samples were then removed prior to the second run. The preprocessed data from the the second run was used for the following analysis. Both β-values and M-values were generated, and β-values were used for all analyses.
The pipeline includes the following main steps:
1. IDAT files were processed to generate an RGSet object.
2. Background correction was performed, white blood cell (WBC) subtypes were estimated, and 56 SNP probes were extracted.
3. Probes in the RGSet were classified into six groups for probe-type–specific preprocessing: Type I Green M, Type I Green U, Type I Red M, Type I Red U, Type II Green, and Type II Red.
4. Control probes were extracted and used to derive principal components (PCs) representing technical variation, which were included as covariates in downstream linear regression models.
5. Detection P-values were extracted and used to filter low-quality probes.
6. Probe-level data were summarized to CpG marker–level data.
7. CpG markers were stratified into autosomal, X-chromosomal, and Y-chromosomal groups, and subsequent preprocessing steps were performed separately for each group.
8. High-level quality control (QC) was conducted by calculating detection P-values and filtering probes and samples based on call rate thresholds.
9. Low-level QC included identification of sex mismatches and filtering CpG markers based on probe-type–specific call rates.
10. Stratified quantile normalization was applied to β-values from autosomal and sex chromosome probes.
11. Principal component analysis (PCA) was performed on control probe intensities to assess technical batch effects.
12. The interquartile range (IQR) was calculated to identify and remove outlier CpG markers.
13. A final cleaned dataset of DNA methylation β-values was generated for downstream analy


**Step 4: Estimation of genetic and epigenetic contributions to blood protein variance**
This step consisted of four main components: 
1. calculation of the genetic relationship matrix (GRM)

inputfile=${inputdir}/chr${chr}.dose.vcf.gz
snp_pruned=${outputdir}/snp_pruned_chr${chr}
bed_pruned=${outputdir}/bed_pruned_chr${chr}
grm_pruned=${outputdir}/grm_pruned_chr${chr}
bed_merged=${outputdir}/bed_merged
grm_merged=${outputdir}/grm_merged 

# prune SNPs for each chromosome
for chr in {1..22}
do
    echo chr${chr}
    inputfile=${inputdir}/chr${chr}.dose.vcf.gz
    snp_pruned=${outputdir}/snp_pruned_chr${chr}
    bed_pruned=${outputdir}/bed_pruned_chr${chr}
    echo Processing ${inputfile}
    
    plink2 --threads 30 --vcf $inputfile --snps-only --maf 0.05 --hwe 1e-6 --indep-pairwise 50 5 0.2 --out $snp_pruned
      wc -l ${snp_pruned}.prune.in
      wc -l ${snp_pruned}.prune.out
    plink2 --threads 30 --vcf $inputfile --extract ${snp_pruned}.prune.in --make-bed --out $bed_pruned
done

# merge SNPs from all chromosomes
for chr in {2..22}
do
   echo $chr
   echo chr${chr}_pruned.bed chr${chr}_pruned.bim chr${chr}_pruned.fam >> ${outputdir}/merged_pruned.txt
done
plink2 --bfile chr1_pruned --merge-list merged_pruned.txt --make-bed --out $merged_bed

# calculate GRM
gcta64 --thread-num 10 --bfile $merged_bed --make-grm --out $merged_grm

# check GRM using R language
prefix='grm_merged'
    BinFileName=paste(prefix,".grm.bin",sep="")
    NFileName=paste(prefix,".grm.N.bin",sep="")
    IDFileName=paste(prefix,".grm.id",sep="")
ids=read.table(IDFileName, header = FALSE)
    colnames(ids)=c("FID", "IID")
    head(ids)
    nrow(ids)
N_values=readBin(NFileName, what = numeric(), n = nrow(ids) * (nrow(ids) + 1) / 2, size = 4)
    length(N_values)
    head(N_values)
grm_values=readBin(BinFileName, what = numeric(), n = nrow(ids) * (nrow(ids) + 1) / 2, size = 4)
    length(grm_values) 
    head(grm_values)
n=nrow(ids)  # Number of individuals
GRM=matrix(0, n, n)  # Initialize an empty matrix
    k=1
    for (i in 1:n) {
      for (j in 1:i) {
        GRM[i, j]=grm_values[k]  # Fill lower triangle
        GRM[j, i]=grm_values[k]  # Fill upper triangle (since it's symmetric)
        k=k+1
      }
    }
    dim(GRM)
    GRM[1:5, 1:5]
    rownames(GRM)=ids$IID
    colnames(GRM)=ids$IID
    save(GRM,file='da.GRM_W.RData')
    sum(is.na(GRM)) 
    summary(diag(GRM)) 
    temp1=GRM[lower.tri(GRM,diag=F)]
    length(temp1) 
    summary(temp1)    
    hist(temp1[temp1<0.02], breaks=200, xlab="Genetic relationship (kinship)", main="")
    hist(temp1[temp1>0.02], breaks=200, xlab="Genetic relationship (kinship)", main="")

# prefix='grm_merged'
    BinFileName=paste(prefix,".grm.bin",sep="")
    NFileName=paste(prefix,".grm.N.bin",sep="")
    IDFileName=paste(prefix,".grm.id",sep="")
ids=read.table(IDFileName, header = FALSE)
    colnames(ids)=c("FID", "IID")
    head(ids)
    nrow(ids)
N_values=readBin(NFileName, what = numeric(), n = nrow(ids) * (nrow(ids) + 1) / 2, size = 4)
    length(N_values) 
    head(N_values)
grm_values=readBin(BinFileName, what = numeric(), n = nrow(ids) * (nrow(ids) + 1) / 2, size = 4)
    length(grm_values)
    head(grm_values)
    summary(grm_values)

n=nrow(ids)  # Number of individuals
GRM=matrix(0, n, n)  # Initialize an empty matrix
    k=1
    for (i in 1:n) {
      for (j in 1:i) {
        GRM[i, j]=grm_values[k]  # Fill lower triangle
        GRM[j, i]=grm_values[k]  # Fill upper triangle (since it's symmetric)
        k=k+1
      }
    }

    dim(GRM)
    GRM[1:5, 1:5]
    rownames(GRM)=ids$IID
    colnames(GRM)=ids$IID
    sum(is.na(GRM))    
    summary(diag(GRM))
    temp1=GRM[lower.tri(GRM,diag=F)]
    length(temp1)  # 43659840
    summary(temp1)
    
    hist(temp1[temp1<0.02], breaks=200, xlab="Genetic relationship (kinship)", main="")
    hist(temp1[temp1>0.02], breaks=200, xlab="Genetic relationship (kinship)", main="")

# remove cryptic relatedness
gcta64 --grm $grm_merged --grm-cutoff 0.1 --make-grm --out ${outputdir}/grm_final # 0.025

prefix='grm_final'
    BinFileName=paste(prefix,".grm.bin",sep="")  # values
    NFileName=paste(prefix,".grm.N.bin",sep="")  # N of used SNP, only one value, although a long length
    IDFileName=paste(prefix,".grm.id",sep="")    # IDs for sample
ids=read.table(IDFileName, header = FALSE)
    colnames(ids)=c("FID", "IID")
N_values=readBin(NFileName, what = numeric(), n = nrow(ids) * (nrow(ids) + 1) / 2, size = 4)
    length(N_values)
    head(N_values)    
grm_values=readBin(BinFileName, what = numeric(), n = nrow(ids) * (nrow(ids) + 1) / 2, size = 4)
    length(grm_values)
    head(grm_values)
    summary(grm_values)
n=nrow(ids)
GRM=matrix(0, n, n)  # Initialize an empty matrix
    k=1
    for (i in 1:n) {
      for (j in 1:i) {
        GRM[i, j]=grm_values[k]  # Fill lower triangle
        GRM[j, i]=grm_values[k]  # Fill upper triangle (since it's symmetric)
        k=k+1
      }
    }
    dim(GRM)   
    GRM[1:5, 1:5]
    rownames(GRM)=ids$IID
    colnames(GRM)=ids$IID
    sum(is.na(GRM)) # 0
    temp1=GRM[lower.tri(GRM)]
    length(temp1)
    summary(temp1)

2. calculation of the methylation relationship matrix (MRM)
# write beta values in a text file
temp1=rownames(betas)
file_conn <- file("/gpfs/data/aric/projects/08_EWAS_of_Proteome/Datasets/ARIC_epigenetics/tmethylation.txt", "w")
cat(paste(c('IID',colnames(betas)), collapse = " "), "\n", file = file_conn)
for (i in 1:nrow(betas)) {
  if(i%%1000==0) print(i)
  cat(paste(c(temp1[i],round(betas[i, ],4)), collapse = " "), "\n", file = file_conn)
}
close(file_conn)

# convert text to befile for osca, filter, and estimate ORM
osca --tefile tmethylation.txt --methylation-beta --make-bod --no-fid --out tmethylation_bod  # --efile/tefile
osca --befile tmethylation_bod --get-variance --get-mean --out tmethylation_stats
osca --befile tmethylation_bod --upper-beta 0.8 --lower-beta 0.2 --make-bod --out tmethylation_bod2
osca --befile tmethylation_bod2 --make-orm --out methylation_orm

3. estimation of the variance explained by the GRM and MRM using OREML
*prepare phenotypes (proteins), genetic PCs, methylation PCs, and covariates before this step
*i is the ith PC of proteome
osca --reml --multi-orm orm.filelist --pheno proteome_pc${i} --out myreml_${i}

**Step 5: Epigenome-wide association study (EWAS) of circulating proteins**
fun_ewas_protein<-function(var.x=var.x, var.race=var.race,var.suffix='',methylationAsOutcome=F,Mvalue=F,INT=F){

    load('var.queryall.RData')
    inputdir='./chunk_betaQN'
    resultdir="./Results")
    var.group=var.queryall$group[var.queryall$var==var.x]
    var.group
    outputdir=paste0(resultdir,var.group)
        if(!dir.exists(outputdir)) {dir.create(outputdir)}
    var.symbol=var.queryall$symbol[var.queryall$var==var.x]
    
    var.covariates1=c('methy_id','RACEGRP51','CENTER')
    var.covariates2=c('CD8T','CD4T','NK','Bcell','Mono','Neu','PC1_cp','PC2_cp','PC3_cp','PC4_cp','PC5_cp','PC6_cp','PC7_cp','PC8_cp','PC9_cp','PC10_cp','PC1','PC2','PC3','PC4','PC5') 
    
    load('./da.IDs_flag.RData')
    var.samples_exclude=da.IDs_flag$row_names[(da.IDs_flag$flag_sexmismatch==1 | da.IDs_flag$flag_genotypemismatch==1) & !is.na(da.IDs_flag$flag_sexmismatch) & !is.na(da.IDs_flag$flag_genotypemismatch)]
        length(var.samples_exclude)  # 37
    
    ans=foreach(fileid=1:50, .combine=rbind) %dopar% {
        cat(paste0('Loading chunk ',fileid), '\n')
    
        load('./da.methylome_pheno_merged.RData')
        da.methylome_pheno=da.methylome_pheno[,c(var.x,var.covariates1)]
        da.methylome_pheno$var.x=as.vector(da.methylome_pheno[[var.x]])        
        
        # inverse normal transformation
        if(INT==T) da.methylome_pheno$var.x=qnorm((rank(da.methylome_pheno$var.x,na.last="keep")-0.5)/sum(!is.na(da.methylome_pheno$var.x)))

        # add covariates
        load('./da.covar_PCWBC.RData')
        da.covar_PCWBC=da.covar_PCWBC[,var.covariates2]
        #table(da.methylome_pheno$methy_id %in% rownames(da.covar_PCWBC))
        #table(rownames(da.covar_PCWBC) %in% da.methylome_pheno$methy_id)
        input_file=paste0(inputdir,'/betaQN.all_',fileid,'_IQR.RDS')
        da.methylome=readRDS(input_file)
        da.methylome_num=nrow(da.methylome)   # CpG number
        cat(paste0(da.methylome_num,' CpGs are loaded.'), '\n') 
        
        da.temp=cbind(da.methylome_pheno, da.covar_PCWBC)
            dim(da.temp)
            
        var.subset=da.methylome_pheno$RACEGRP51==var.race            
            table(var.subset) 
        var.samples=intersect(da.methylome_pheno$methy_id[var.subset], colnames(da.methylome))
            var.samples=var.samples[!var.samples %in% var.samples_exclude]
            length(var.samples) # 426 for black with methylome
            
        da.temp=da.temp[match(var.samples,da.temp$methy_id),]   
            dim(da.temp)
            da.temp=da.temp[complete.cases(da.temp),]
            dim(da.temp)
            da.temp$id=1:nrow(da.temp)
            da.temp_num=nrow(da.temp) 
      
        da.methylome=da.methylome[,da.temp$methy_id]
        res.temp=data.frame(cpg=rownames(da.methylome),num=NA,beta=NA,se=NA,P=NA)
        for(i in 1:da.methylome_num){
              da.temp$betavalue=temp1=NA
              if(i %% 5000 == 1) cat(paste0("Scanning ",i, 'th CpG in chunk ',fileid, ' (PID:',Sys.getpid(),')\n'))
              da.temp$betavalue=as.vector(da.methylome[i,])
              
              if(isTRUE(Mvalue)){ # covert beta value to M value
                  da.temp$betavalue[da.temp$betavalue<0.001 | da.temp$betavalue>0.999]=NA
                  da.temp$betavalue=log2(da.temp$betavalue)-log2(1-da.temp$betavalue)
              }
              
              if(sum(!is.na(da.temp$betavalue))/da.temp_num>=0.70){ # some CpGs have too many missing values
                  if(isTRUE(methylationAsOutcome)){
                      if(var.race=='B'){
                          temp1=lm(betavalue~var.x+egfrcrcys_v5+V5AGE51+GENDER51+CD8T+CD4T+NK+Bcell+Mono+Neu+PC1_cp+PC2_cp+PC3_cp+PC4_cp+PC5_cp+PC6_cp+PC7_cp+PC8_cp+PC9_cp+PC10_cp+PC1+PC2+PC3+PC4+PC5, data=da.temp)
                      }else{
                          temp1=lm(betavalue~var.x+egfrcrcys_v5+CENTER+V5AGE51+GENDER51+CD8T+CD4T+NK+Bcell+Mono+Neu+PC1_cp+PC2_cp+PC3_cp+PC4_cp+PC5_cp+PC6_cp+PC7_cp+PC8_cp+PC9_cp+PC10_cp+PC1+PC2+PC3+PC4+PC5, data=da.temp)
                      }
                  }else{
                      if(var.race=='B'){
                          temp1=lm(var.x~betavalue+CD8T+CD4T+NK+Bcell+Mono+Neu+PC1_cp+PC2_cp+PC3_cp+PC4_cp+PC5_cp+PC6_cp+PC7_cp+PC8_cp+PC9_cp+PC10_cp+PC1+PC2+PC3+PC4+PC5, data=da.temp)
                      }else{
                          temp1=lm(var.x~betavalue+CENTER+CD8T+CD4T+NK+Bcell+Mono+Neu+PC1_cp+PC2_cp+PC3_cp+PC4_cp+PC5_cp+PC6_cp+PC7_cp+PC8_cp+PC9_cp+PC10_cp+PC1+PC2+PC3+PC4+PC5, data=da.temp)
                      }
                  }
                  temp1=summary(temp1)$coeff
                  res.temp$num=sum(!is.na(da.temp$betavalue))
                  res.temp$beta[i]=temp1[2,1]
                  res.temp$se[i]=temp1[2,2]
                  res.temp$P[i]=temp1[2,4]
              }
        }
        cat(paste0('Completed chunk ',fileid), '\n')
        #saveRDS(res.temp,file=paste0(outputdir,'/chunk_',fileid,'.rds'))
        res.temp
    }
    
    ans=dplyr::arrange(ans,P)
    
    cat('CpG number: ',nrow(ans),'\n')
    cat('NA number: ',sum(is.na(ans$P)),'\n')
    cat('summary beta: \n')
    print(summary(ans$beta))
    cat('summary P:\n')
    print(summary(ans$P))
    cat('min raw P:', min(ans$P, na.rm=T),'\n')

    load('./da.methylome_annot_simple.RData')
    temp1=match(ans$cpg,da.methylome_annot_simple$IlmnID)
        ans$chr=da.methylome_annot_simple$CHR_hg38[temp1]
        ans$pos=da.methylome_annot_simple$Start_hg38[temp1]
        ans$gene=da.methylome_annot_simple$UCSC_RefGene_Name[temp1]
        ans$location=da.methylome_annot_simple$UCSC_RefGene_Group[temp1]
        ans$CpGIsland=da.methylome_annot_simple$UCSC_CpG_Islands_Name[temp1]
        ans$CpGIsland_location=da.methylome_annot_simple$Relation_to_UCSC_CpG_Island[temp1]
        ans$regulatory_feature=da.methylome_annot_simple$Regulatory_Feature_Group[temp1]
    head(ans)   
    
    saveRDS(ans,file=paste0(outputdir,'/',var.x,'_',var.race,var.suffix,'.rds'))
    
    load('./var.queryall.RData')
    var.symbol_short=var.symbol
    if(stringr::str_length(var.symbol_short)>31) var.symbol_short=stringr::str_sub(var.symbol_short,1,31)
    outputexcel=paste0(resultdir,'Table3_',var.symbol,'_',var.race,var.suffix,'.xlsx') 
    openxlsx::write.xlsx(ans[ans$P<0.05,],file=outputexcel,sheetName=var.symbol_short,firstRow=T)
   
    outputqqplot=paste0(resultdir,'Fig_qqplot_',var.symbol,'_',var.race,var.suffix,'.jpeg') 
    jpeg(filename=outputqqplot, width=600, height=600)
       qqman::qq(ans$P,main=paste0(var.symbol,' in ',var.race))
    dev.off()
}

**Step 6: Gene Ontology enrichment analysis of pQTMs**
library(ggplot2)
library(ggrepel)
    
load('./Results/pQTM/res.GOcis_All.RData')    
load('./Results/pQTM/res.GOtrans_All.RData')    
    dim(res.GOcis)   
    dim(res.GOtrans)
    res.GOcis$GO=rownames(res.GOcis)
    res.GOtrans$GO=rownames(res.GOtrans)
    head(res.GOcis)
    
    topGSA(res.GOcis)
    
res.GOcommon=intersect(res.GOcis$GO[res.GOcis$FDR<0.05], res.GOtrans$GO[res.GOtrans$FDR<0.05]) 
    length(res.GOcommon) 

res.GOsig=unique(res.GOcis$GO[res.GOcis$FDR<0.05], res.GOtrans$GO[res.GOtrans$FDR<0.05]) 
    length(res.GOsig)    
    head(res.GOsig)

res.GOsig=res.GOcis$GO        
    length(res.GOsig)    
    
temp1=res.GOcis[match(res.GOsig,res.GOcis$GO),]    
    temp1$score=temp1$DE/temp1$N
    temp1$log10p=-log10(temp1$FDR)
    names(temp1)=paste0('cis_',names(temp1))
    head(temp1)

temp2=res.GOtrans[match(res.GOsig,res.GOtrans$GO),]
    temp2$score=temp2$DE/temp2$N
    temp2$log10p=-log10(temp2$FDR)
    names(temp2)=paste0('trans_',names(temp2))
    head(temp2)
    table(rownames(temp1)==rownames(temp2))
    
res.GOcombined=cbind(temp1,temp2)    
    head(res.GOcombined)
    dim(res.GOcombined)
    
    res.GOcombined=res.GOcombined[res.GOcombined$cis_FDR!=1 | res.GOcombined$trans_FDR!=1,] # remove no hit GO
    dim(res.GOcombined) # 352  18
    
    res.GOcombined$col='gray'
    res.GOcombined$col[res.GOcombined$cis_FDR<0.05 & res.GOcombined$trans_FDR>=0.05]=col.posnegcistrans$col[col.posnegcistrans$class==5]
    res.GOcombined$col[res.GOcombined$cis_FDR>=0.05 & res.GOcombined$trans_FDR<0.05]=col.posnegcistrans$col[col.posnegcistrans$class==6]
    res.GOcombined$col[res.GOcombined$cis_FDR<0.05 & res.GOcombined$trans_FDR<0.05]='blue'
    table(res.GOcombined$col)
    
    res.GOcombined$group='not enriched'
    res.GOcombined$group[res.GOcombined$cis_FDR<0.05 & res.GOcombined$trans_FDR>=0.05]="only enriched for cis-pQTM"
    res.GOcombined$group[res.GOcombined$cis_FDR>=0.05 & res.GOcombined$trans_FDR<0.05]="only enriched for trans-pQTM"
    res.GOcombined$group[res.GOcombined$cis_FDR<0.05 & res.GOcombined$trans_FDR<0.05]="enriched for both"
    table(res.GOcombined$group)
    
    res.GOcombined$label=NA
    temp3=res.GOcombined$cis_log10p>8 | res.GOcombined$trans_log10p>3
    table(temp3)
    res.GOcombined$label[temp3]=res.GOcombined$cis_TERM[temp3]
    head(res.GOcombined)

    res.GOcombined$cis_log2p=-log2(res.GOcombined$cis_FDR)
    res.GOcombined$trans_log2p=-log2(res.GOcombined$trans_FDR)
    
    res.GOcombined$cis_logit=log10(res.GOcombined$cis_FDR/(1-res.GOcombined$cis_FDR))
    res.GOcombined$trans_logit=log10(res.GOcombined$trans_FDR/(1-res.GOcombined$trans_FDR))

plot(res.GOcombined$cis_log10p~res.GOcombined$trans_log10p,pch=20,cex=0.6,col=res.GOcombined$col,
     xlab='-log10(FDR) for trans-pQTM',ylab='-log10(FDR) for cis-pQTM')

ggplot(res.GOcombined, aes(x=trans_log10p, y=cis_log10p, color=col, label = label)) +
  geom_point(size=1)+ geom_text_repel()+
  scale_color_identity()+ theme_bw()+
  labs(title = "", x="-log10(FDR) for trans-pQTM", y="-log10(FDR) for cis-pQTM")+
  xlim(0,12)+ylim(0,11)

# all significant GO terms
ggplot(res.GOcombined, aes(x=trans_log10p, y=cis_log10p, color=col, label = label,group=group)) +
  geom_point(size=1)+ 
  scale_color_identity()+ theme_bw()+ylim(0,12)+
  labs(title = "", x="-log10(FDR) for trans-pQTMs enrichment", y="-log10(FDR) for cis-pQTMs enrichment")
dev.copy2pdf(file='./Results/pQTM/Fig-GO_enrichment_All.pdf',width=6,height=6)

**Step 7: Decomposition of protein variance by cis-pQTMs and cis-pQTLs**

dim(res.proteinvar_bycpg)  
    head(res.proteinvar_bycpg)
    temp1=table(res.proteinvar_bycpg$cisSNPNum)
    temp1=data.frame(num=as.numeric(names(temp1)),count=as.numeric(temp1))
    temp2=barplot(temp1$count,horiz=T,col=col.posnegcistrans$col[col.posnegcistrans$class==5],border=F, cex.axis=0.8,
                  ylab='number of cis-pQTLs',xlab='number of proteins')
    axis(2, at=as.vector(temp2), labels=paste0(temp1$num),las=2,cex.axis=0.8)
    dev.copy2pdf(file='./Fig-proteinvariance_cisSNPnumber.pdf',width=3,height=5)
    res.proteinvar_bycpg=dplyr::arrange(res.proteinvar_bycpg,desc(vartopcpg))
    res.proteinvar_bycpg$ciscpg_len=0
    res.proteinvar_bycpg$ciscpg=NA
    head(res.proteinvar_bycpg)
    head(da.temp)
    for(i in 1:nrow(res.proteinvar_bycpg)){
       temp1=temp2=temp3=NA
       temp1=res.proteinvar_bycpg$seqid[i]
       temp1=da.temp[da.temp$seqid==temp1 & da.temp$cis==1,]
       if(nrow(temp1)>=0)
       {
         temp1=unique(temp1$cpg)
         res.proteinvar_bycpg$ciscpg_len[i]=length(temp1)
         res.proteinvar_bycpg$ciscpg[i]=paste0(temp1,collapse=',')
       }
    }    
    head(res.proteinvar_bycpg)
    res.proteinvar_bycpg$ciscpg_len      
save(res.proteinvar_bycpg,file='./Results/pQTM/res.proteinvar_bycpg3.RData')
load('./Results/pQTM/res.proteinvar_bycpg.RData');dim(res.proteinvar_bycpg)
load('./Results/pQTM/res.proteinvar_bycpg2.RData');dim(res.proteinvar_bycpg)
load('./Results/pQTM/res.proteinvar_bycpg3.RData');dim(res.proteinvar_bycpg)
    names(res.proteinvar_bycpg)

load('./Results/pQTM/res.proteinvar_bycpg3.RData')
  names(res.proteinvar_bycpg)
  dim(res.proteinvar_bycpg)
  head(res.proteinvar_bycpg)
  table(res.proteinvar_bycpg$cisSNPNum==0)   # T:7, F:272
  table(res.proteinvar_bycpg$ciscpg_len==0)  # T:0, F:279
  
res.proteinvar_bycpg=res.proteinvar_bycpg[res.proteinvar_bycpg$cisSNPNum!=0,]  
  dim(res.proteinvar_bycpg)  # 272
  
# ID
load('./da.IDs_flag.RData')
load('./da.GWASIDs.RData')
    head(da.IDs_flag)
    head(da.GWASIDs)
    da.IDs_flag$gwasid=da.GWASIDs$gwasid[match(da.IDs_flag$pid,da.GWASIDs$pid)]
    head(da.IDs_flag)
    dim(da.IDs_flag)
    
# SNP matrix
load('./da.snpmatrix_dosage.RData')    
load('./da.snpmatrix_snps.RData')    
    dim(da.snpmatrix_dosage) # 9345 1988
    table(rownames(da.snpmatrix_dosage) %in% da.IDs_flag$pid) # T:1432 F:7913
    
# methylation matrix
load('./da.pQTM_W_betavalue.RData')
    dim(da.pQTM_W_betavalue) # 6986 2092
    da.pQTM_W_betavalue=t(da.pQTM_W_betavalue)
    da.pQTM_W_betavalue[1:10,1:10]
    
# load phenotype
load('./Datasets/da.methylome_pheno_mol.RData')
    dim(da.methylome_pheno)
    da.methylome_pheno[1:5,1:5]  
  
# participant list
var.part_methyid=da.methylome_pheno$methy_id[da.methylome_pheno$white==1 & !is.na(da.methylome_pheno$white)]
    length(var.part_methyid)   
    var.part_methyid[1:10]
    table(var.part_methyid %in% da.IDs_flag$row_names) 
    
var.part_pid=da.IDs_flag$pid[match(var.part_methyid,da.IDs_flag$row_names)]
    length(var.part_pid)  
    var.part_pid[1:10]    

table(var.part_methyid %in% rownames(da.pQTM_W_betavalue))
table(var.part_pid %in% rownames(da.snpmatrix_dosage))    
    
# protein matrix
da.temp0=da.methylome_pheno[match(var.part_methyid,da.methylome_pheno$methy_id),res.proteinvar_bycpg$seqid]   
    head(da.temp0)

# genotype matrix
da.temp2=da.snpmatrix_dosage[match(var.part_pid,rownames(da.snpmatrix_dosage)),]    
    dim(da.temp2)  
     
# methylation matrix    
da.temp3=da.pQTM_W_betavalue[match(var.part_methyid,rownames(da.pQTM_W_betavalue)),]
    dim(da.temp3) 

# covariates
var.covariates1=c('RACEGRP51','V5AGE51','GENDER51','CENTER','egfrcrcys_v5')
da.temp4=da.methylome_pheno[match(var.part_methyid,da.methylome_pheno$methy_id),var.covariates1] 
    dim(da.temp0) 
    head(da.temp4)    
    
load('./da.covar_PCWBC.RData')
var.covariates2=c('CD8T','CD4T','NK','Bcell','Mono','Neu','PC1_cp','PC2_cp','PC3_cp','PC4_cp','PC5_cp','PC6_cp','PC7_cp','PC8_cp','PC9_cp','PC10_cp') 
da.temp5=da.covar_PCWBC[match(var.part_methyid,da.covar_PCWBC$methy_id),var.covariates2]
    head(da.temp5)
    da.temp5[1:6,1:6]

# adjust covar for protein (aka. residualize protein for covar)
da.temp6=da.temp0
    da.temp6[1:10,1:10]
    for(j in 1:ncol(da.temp6)){
      if(j%%50==0) print(j)
      temp1=temp2=NA
      temp1=da.temp4
      temp1$protein=as.vector(da.temp6[,j])
      head(temp1)
      temp2=lm(protein~V5AGE51+GENDER51,data=temp1,na.action=na.exclude)
      da.temp6[,j]=as.vector(scale(resid(temp2),center=T,scale=T))
    }
    da.temp6[1:6,1:6]
    hist(da.temp6$SeqId_6364_7)
    
# calculate R2: collect model1: Protein ~ cis-pQTLS + covariate
names(res.proteinvar_bycpg)
    table(res.proteinvar_bycpg$cisSNPNum)
    table(res.proteinvar_bycpg$ciscpg_len)
    
res.proteinvar_bycpg$varciscpg=0    
res.proteinvar_bycpg$varcissnp=0
res.proteinvar_bycpg$varciscpgadj=0    
res.proteinvar_bycpg$varcissnpadj=0

  for(i in 1:nrow(res.proteinvar_bycpg)){
      temp1=temp2=temp3=temp4=temp5=temp6=resid_methy=resid_snp=NA
      temp1=res.proteinvar_bycpg$seqid[i]
      print(paste0(i,': ',temp1))
      
      # inject beta values of pQTM
      temp2=temp3=temp4=temp5=temp6=NA
      temp2=data.frame(protein=as.vector(scale(da.temp0[[temp1]],center=T,scale=T)))  # da.temp6, da.temp0
      head(temp2)
      temp3=res.proteinvar_bycpg$ciscpg[i]
      temp3=stringr::str_split(temp3,',')[[1]]
      temp3_methy=da.temp3[,temp3,drop = FALSE]
      head(temp3_methy)
      for(j in 1:ncol(temp3_methy)){
        temp6=lm(temp3_methy[,j]~da.temp4$V5AGE51+da.temp4$GENDER51,na.action=na.exclude)
        temp6=as.vector(resid(temp6))
        temp3_methy[,j]=temp6
      }
      temp2=cbind(temp2,temp3_methy)     # matrix containing protein and cis-pQTMs
           head(temp2)
           temp4=NA
           temp4=lm(protein~.,data=temp2,na.action=na.exclude)
      res.proteinvar_bycpg$varciscpg[i]=summary(temp4)$r.squared
      resid_methy=as.vector(resid(temp4)) # 1702
           
      # inject genotype of pQTL
      temp2=temp3=temp4=temp5=temp6=NA
      temp2=data.frame(protein=as.vector(scale(da.temp0[[temp1]],center=T,scale=T)))

      head(temp2)
      temp3=res.proteinvar_bycpg$cisSNPList[i] 
          temp3=stringr::str_split(temp3,',')[[1]]
          temp3=da.snpmatrix_snps$rsID %in% temp3
          table(temp3)
      temp3_snp=da.temp2[,temp3,drop=F]
      head(temp3_snp)
      table(complete.cases(temp3_snp))
      for(j in 1:ncol(temp3_snp)){
        if(length(unique(temp3_snp[,j][!is.na(temp3_snp[,j])]))>1)temp3_snp[,j]=as.vector(scale(temp3_snp[,j]))
      }
      table(complete.cases(temp3_snp))
      temp2=cbind(temp2,temp3_snp)     # matrix containing protein and cis-pQTLs
           head(temp2)
           #names(temp2)[2:length(names(temp2))]=paste0('x',2:length(names(temp2)))
           #temp2$protein[is.na(temp2$protein)]
           #temp2=temp2[complete.cases(temp2),]
           #temp2$x2[is.na(temp2$x2)]=0
           #table(complete.cases(temp2))
           temp4=NA
           temp4=lm(protein~.,data=temp2,na.action=na.exclude)
      res.proteinvar_bycpg$varcissnp[i]=summary(temp4)$r.squared
      resid_snp=as.vector(resid(temp4))   
    
      # residual of protein-SNP: explained by methylation
      temp2=temp3=temp4=temp5=temp6=NA
      temp2=data.frame(protein=resid_snp)             # adjust cis-pQTL      
      head(temp2)
      temp3=res.proteinvar_bycpg$ciscpg[i]
      temp3=stringr::str_split(temp3,',')[[1]]
      temp3_methy=da.temp3[,temp3,drop=F]
      for(j in 1:ncol(temp3_methy)){
        temp3_methy[,j]=as.vector(scale(temp3_methy[,j]))
      }
      temp2=cbind(temp2,temp3_methy,da.temp4$V5AGE51,da.temp4$egfrcrcys_v5)     
           head(temp2)
           temp4=NA
           temp4=lm(protein~.,data=temp2,na.action=na.exclude)
      res.proteinvar_bycpg$varciscpgadj[i]=summary(temp4)$r.squared
      
      # residual of protein-methylation: explained by SNP
      temp2=temp3=temp4=temp5=temp6=NA
      temp2=data.frame(protein=resid_methy)             # adjust cis-pQTL
      #temp2=data.frame(protein=as.vector(scale(da.temp0[[temp1]],center=T,scale=T)))       # not adjust cis-pQTL
      #temp2=data.frame(protein=as.vector(scale(da.temp6[[temp1]],center=T,scale=T)))       # not adjust cis-pQTL
      head(temp2)
      temp3=res.proteinvar_bycpg$cisSNPList[i]
          temp3=stringr::str_split(temp3,',')[[1]]
          temp3=da.snpmatrix_snps$rsID %in% temp3
          table(temp3)
      temp3_snp=da.temp2[,temp3,drop=F]
      for(j in 1:ncol(temp3_snp)){
        if(length(unique(temp3_snp[,j][!is.na(temp3_snp[,j])]))>1) temp3_snp[,j]=as.vector(scale(temp3_snp[,j]))
      }
      temp2=cbind(temp2,temp3_snp)     
           head(temp2)
           temp4=NA
           temp4=lm(protein~.,data=temp2,na.action=na.exclude)
      res.proteinvar_bycpg$varcissnpadj[i]=summary(temp4)$r.squared
    }   
    
head(res.proteinvar_bycpg)
     
openxlsx::write.xlsx(res.proteinvar_bycpg,file='./res.proteinvar_bycpg2.xlsx')
write.csv(res.proteinvar_bycpg,file='./res.proteinvar_bycpg2.csv')
save(res.proteinvar_bycpg,file='./res.proteinvar_bycpg_full.RData')

# figure
load('./Results/Methy_SNP/res.proteinvar_bycpg_full.RData')
res.proteinvar_bycpg$varciscpgadj=(1-res.proteinvar_bycpg$varcissnp)*res.proteinvar_bycpg$varciscpgadj
par(mar=c(4,5,1,1))
res.proteinvar_bycpg$label=''
     temp1=res.proteinvar_bycpg$varcissnp>=0.8 | res.proteinvar_bycpg$varciscpg>=0.5
     table(temp1)
     res.proteinvar_bycpg$label[temp1]=res.proteinvar_bycpg$protein[temp1]  
plot(res.proteinvar_bycpg$varciscpg~res.proteinvar_bycpg$varcissnp,pch=20,col='darkblue', cex=0.6,
     xlab="variance explained by cis-pQTLs", ylab="variance explained by cis-pQTMs")
     #text(res.proteinvar_bycpg$varcissnp,res.proteinvar_bycpg$varciscpg,res.proteinvar_bycpg$label,cex=0.6)
dev.copy2pdf(file='./Fig-proteinvariance_explained.pdf',width=6,height=5)

res.proteinvar_bycpg$label=''
     temp1=res.proteinvar_bycpg$varciscpgadj>=0.15 | res.proteinvar_bycpg$varcissnpadj>=0.5
     table(temp1)
     res.proteinvar_bycpg$label[temp1]=res.proteinvar_bycpg$protein[temp1]     
plot(res.proteinvar_bycpg$varciscpgadj~res.proteinvar_bycpg$varcissnpadj,pch=20,col='darkblue', cex=0.6,
     xlab="variance explained by cis-pQTLs \n after adjusting cis-pQTMs", 
     ylab="variance explained by cis-pQTMs \n after adjusting cis-pQTLs")
     #text(res.proteinvar_bycpg$varcissnpadj,res.proteinvar_bycpg$varciscpgadj,res.proteinvar_bycpg$label,cex=0.6)
dev.copy2pdf(file='./Fig-proteinvariance_explained2.pdf',width=6,height=5)

res.proteinvar_bycpg$others=1-res.proteinvar_bycpg$varciscpgadj-res.proteinvar_bycpg$varcissnpadj 
res.proteinvar_bycpg$vartotal=1
     summary(res.proteinvar_bycpg$varciscpgadj+res.proteinvar_bycpg$varcissnpadj)    
     
res.proteinvar_bycpg=dplyr::arrange(res.proteinvar_bycpg,desc(varciscpgadj))
    head(res.proteinvar_bycpg)
    res.proteinvar_bycpg$x=1:nrow(res.proteinvar_bycpg)
    res.proteinvar_bycpg$y1=res.proteinvar_bycpg$varciscpgadj
    res.proteinvar_bycpg$y2=res.proteinvar_bycpg$varciscpgadj+res.proteinvar_bycpg$varcissnp
    
temp1=res.proteinvar_bycpg
    temp11=temp1[temp1$varciscpgadj/temp1$varcissnpadj>=0.4,]
    temp12=temp1[temp1$varciscpgadj/temp1$varcissnpadj<0.4,]
    
    temp11=dplyr::arrange(temp11,desc(varciscpgadj))
    temp12=dplyr::arrange(temp12,varcissnpadj)
    temp1=rbind(temp11,temp12)
    
    head(temp1$cisSNPNum)
    tail(temp1$cisSNPNum)
    head(temp1$ciscpg_len)
    tail(temp1$ciscpg_len)
    
par(mar=c(4,4,2,3),mgp=c(2,0.5,0))
    temp2=barplot(temp1$vartotal,border=NA,space=0.2,horiz=F,las=2,cex.names=0.4,xlab='',ylab='variance explained',
            col=col.partition$col[col.partition$group=='Others'],xaxs = "i") # names.arg=res.proteinvar_bycpg$protein
    head(temp2,2)
    tail(temp2,2)
    barplot(temp1$varciscpgadj+temp1$varcissnpadj,border=NA,space=0.2,horiz=F,las=2,xlab='',ylab='',col=col.partition$col[col.partition$group=='Genetics'],add=T)
    barplot(temp1$varciscpgadj,border=NA,space=0.2,horiz=F,las=2,xlab='',ylab='',col=col.partition$col[col.partition$group=='Methylation'],add=T)
    axis(1, at=as.vector(temp2), labels = temp1$protein,las = 2, cex.axis = 0.4, tck=0)
    box()
dev.copy2pdf(file='./Fig-proteinvariance_explained4.pdf',width=20,height=5)

# add bottom heatmap    
load('./Results/pQTM/da.pQTM_cis_All.RData')
res.GOcis=gometh(sig.cpg=da.pQTM_cis_W, all.cpg=NULL, array.type = "EPIC", collection = "GO",sig.genes=T)

res.select_proteins_sorted_GO=NA
    table(res.GO_top20_cis_trans_both$group)   
    temp1=tail(res.GO_top20_cis_trans_both[res.GO_top20_cis_trans_both$group=='only_cispQTMs',],N)
    temp1=data.frame(GO=rownames(temp1),term=temp1$cis_TERM)[N:1,]
    temp1
    for(i in 1:N){
      print(i)
      if(temp1$GO[i] %in% keys(org.Hs.eg.db, keytype = "GO")){
          temp2=NA
          temp2=AnnotationDbi::select(org.Hs.eg.db,keys=temp1$GO[i],keytype = "GO",columns = c("SYMBOL"))
          temp2=as.numeric(var.select_proteins_sorted %in% temp2$SYMBOL)
          temp2=data.frame(t(matrix(temp2)))
          rownames(temp2)=paste0(temp1$GO[i],'(',temp1$term[i],')')
          colnames(temp2)=var.select_proteins_sorted
          
          if(sum(temp2)>0){
              if(is.logical(res.select_proteins_sorted_GO)){
                res.select_proteins_sorted_GO=temp2
              }else{
                res.select_proteins_sorted_GO=rbind(res.select_proteins_sorted_GO,temp2)
              }
          }
      }else{
          temp2=matrix(0,nrow=length(var.select_proteins_sorted),ncol=1)
      }
    }
    
    temp1=tail(res.GO_top20_cis_trans_both[res.GO_top20_cis_trans_both$group=='only_transpQTMs',],N)
    temp1=data.frame(GO=rownames(temp1),term=temp1$cis_TERM)[N:1,]
    temp1
    for(i in 1:N){
      print(i)
      if(temp1$GO[i] %in% keys(org.Hs.eg.db, keytype = "GO")){
          temp2=NA
          temp2=AnnotationDbi::select(org.Hs.eg.db,keys=temp1$GO[i],keytype = "GO",columns = c("SYMBOL"))
          temp2=as.numeric(var.select_proteins_sorted %in% temp2$SYMBOL)
          temp2=data.frame(t(matrix(temp2)))
          rownames(temp2)=paste0(temp1$GO[i],'(',temp1$term[i],')')
          colnames(temp2)=var.select_proteins_sorted
          
          if(sum(temp2)>0){
              if(is.logical(res.select_proteins_sorted_GO)){
                res.select_proteins_sorted_GO=temp2
              }else{
                res.select_proteins_sorted_GO=rbind(res.select_proteins_sorted_GO,temp2)
              }
          }
      }else{
          temp2=matrix(0,nrow=length(var.select_proteins_sorted),ncol=1)
      }
    }
    
    temp1=tail(res.GO_top20_cis_trans_both[res.GO_top20_cis_trans_both$group=='both',],N)
    temp1=data.frame(GO=rownames(temp1),term=temp1$cis_TERM)[N:1,]
    temp1
    for(i in 1:N){
      print(i)
      if(temp1$GO[i] %in% keys(org.Hs.eg.db, keytype = "GO")){
          temp2=NA
          temp2=AnnotationDbi::select(org.Hs.eg.db,keys=temp1$GO[i],keytype = "GO",columns = c("SYMBOL"))
          temp2=as.numeric(var.select_proteins_sorted %in% temp2$SYMBOL)
          temp2=data.frame(t(matrix(temp2)))
          rownames(temp2)=paste0(temp1$GO[i],'(',temp1$term[i],')')
          colnames(temp2)=var.select_proteins_sorted
          
          if(sum(temp2)>0){
              if(is.logical(res.select_proteins_sorted_GO)){
                res.select_proteins_sorted_GO=temp2
              }else{
                res.select_proteins_sorted_GO=rbind(res.select_proteins_sorted_GO,temp2)
              }
          }
      }else{
          temp2=matrix(0,nrow=length(var.select_proteins_sorted),ncol=1)
      }
    }
    
    res.select_proteins_sorted_GO[,1:10]
    table(unlist(res.select_proteins_sorted_GO))    
table(as.vector(res.select_proteins_sorted_GO[1,]))

Heatmap(res.select_proteins_sorted_GO,cluster_columns = F,cluster_rows = F,  row_names_side = "left", 
              rect_gp = gpar(col = NA,fill='white'),
              row_names_gp = gpar(just = "left"),
              cell_fun = function(j, i, x, y, width, height, fill) {
                  if(res.select_proteins_sorted_GO[i, j]==1){
                      grid.circle(x = x, y = y,
                          r = unit(1.2, "mm"),
                          gp = gpar(fill="#377EB8", col = NA))
                  }
              },
              show_heatmap_legend=F)
dev.copy2pdf(file='./Fig-proteinvariance_explained_bottomheatmap.pdf',width=28,height=10)
    
temp1=res.proteinvar_bycpg
    temp1=dplyr::arrange(temp1,desc(varciscpgadj))
    temp1=temp1[1:30,]
    
par(mar=c(4,4,2,3),mgp=c(2,0.5,0))
    temp2=barplot(temp1$vartotal,border=NA,space=0.2,horiz=F,las=2,cex.names=0.4,xlab='',ylab='variance explained',
            col=col.partition$col[col.partition$group=='Others'],xaxs = "i") # names.arg=res.proteinvar_bycpg$protein
    head(temp2,2)
    tail(temp2,2)
    barplot(temp1$varciscpgadj+temp1$varcissnpadj,border=NA,space=0.2,horiz=F,las=2,xlab='',ylab='',col=col.partition$col[col.partition$group=='Genetics'],add=T)
    barplot(temp1$varciscpgadj,border=NA,space=0.2,horiz=F,las=2,xlab='',ylab='',col=col.partition$col[col.partition$group=='Methylation'],add=T)
    axis(1, at=as.vector(temp2), labels=temp1$protein,las = 2, cex.axis=0.8, tck=0)
    box()
dev.copy2pdf(file='./Fig-proteinvariance_explained4_1.pdf',width=6,height=5)

temp1=res.proteinvar_bycpg
    temp1=dplyr::arrange(temp1,varcissnpadj)
    temp1=tail(temp1,30)
    
par(mar=c(4,4,2,3),mgp=c(2,0.5,0))
    temp2=barplot(temp1$vartotal,border=NA,space=0.2,horiz=F,las=2,cex.names=0.4,xlab='',ylab='variance explained',
            col=col.partition$col[col.partition$group=='Others'],xaxs = "i") # names.arg=res.proteinvar_bycpg$protein
    head(temp2,2)
    tail(temp2,2)
    barplot(temp1$varciscpgadj+temp1$varcissnpadj,border=NA,space=0.2,horiz=F,las=2,xlab='',ylab='',col=col.partition$col[col.partition$group=='Genetics'],add=T)
    barplot(temp1$varciscpgadj,border=NA,space=0.2,horiz=F,las=2,xlab='',ylab='',col=col.partition$col[col.partition$group=='Methylation'],add=T)
    axis(1, at=as.vector(temp2), labels=temp1$protein,las = 2, cex.axis=0.8, tck=0)
    box()
dev.copy2pdf(file='./Fig-proteinvariance_explained4_2.pdf',width=6,height=5)
